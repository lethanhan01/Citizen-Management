name: CI

on:
    push:
        branches: [main]
    pull_request:
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.x"
                  cache: "npm"
                  cache-dependency-path: |
                      package-lock.json
                      client/package-lock.json
                      server/package-lock.json

            - name: Install root dependencies (if any)
              run: |
                  if [ -f package-lock.json ]; then npm ci; elif [ -f package.json ]; then npm i; fi

            - name: Install client dependencies
              run: |
                  if [ -f client/package-lock.json ]; then npm ci --prefix client; elif [ -f client/package.json ]; then npm i --prefix client; fi

            - name: Install server dependencies
              run: |
                  if [ -f server/package-lock.json ]; then npm ci --prefix server; elif [ -f server/package.json ]; then npm i --prefix server; fi

            - name: Build client
              run: npm --prefix client run build --if-present

            - name: Build server (if present)
              run: npm --prefix server run build --if-present

            - name: Lint (if present)
              run: |
                  npm run lint --if-present || true
                  npm --prefix client run lint --if-present || true
                  npm --prefix server run lint --if-present || true

            - name: Test (if present)
              run: |
                  npm test --if-present --silent || true
                  npm --prefix client test --if-present --silent || true
                  npm --prefix server test --if-present --silent || true

            - name: Upload client build artifact (if exists)
              if: ${{ hashFiles('client/dist/**') != '' }}
              uses: actions/upload-artifact@v4
              with:
                  name: client-dist
                  path: client/dist

            - name: Upload server build artifact (if exists)
              if: ${{ hashFiles('server/dist/**') != '' }}
              uses: actions/upload-artifact@v4
              with:
                  name: server-dist
                  path: server/dist

    deploy-client:
        name: Deploy client to Vercel (main only)
        needs: build
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        env:
            VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
            VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
            VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "24.x"
                  cache: "npm"
                  cache-dependency-path: client/package-lock.json

            - name: Install Vercel CLI
              run: npm install --global vercel@latest

            - name: Pull Vercel environment configuration
              working-directory: client
              run: vercel pull --yes --environment=production --token=${{ env.VERCEL_TOKEN }}

            - name: Build client with Vercel
              working-directory: client
              run: vercel build --prod --token=${{ env.VERCEL_TOKEN }}

            - name: Deploy client to Vercel
              working-directory: client
              run: vercel deploy --prebuilt --prod --token=${{ env.VERCEL_TOKEN }}
